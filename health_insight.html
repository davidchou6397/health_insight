<!DOCTYPE html>
<html lang="zh-TW" id="htmlElement">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">姿勢評估與輔具推薦系統 | AI智能姿勢分析 | MediaPipe技術</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" id="pageDescription" content="線上姿勢評估系統，使用AI MediaPipe技術精準分析姿勢問題，提供個人化輔具推薦。改善駝背、頸椎前傾、脊椎側彎等問題。">
    <meta name="keywords" content="姿勢評估,姿勢分析,駝背矯正,頸椎前傾,脊椎側彎,輔具推薦,人體工學,MediaPipe,AI姿勢檢測,免費,線上評估">
    <meta name="author" content="姿勢健康專家">
    <meta name="robots" content="index, follow">
    <meta name="language" content="zh-TW">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="AI姿勢評估系統 - 精準分析您的姿勢問題">
    <meta property="og:description" content="使用先進MediaPipe技術，免費分析您的姿勢，提供專業輔具建議。立即改善駝背、頸椎等問題！">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://davidchou6397.github.io/health_insight/health_insight.html">
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GMVZFKTG02"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-GMVZFKTG02');
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    
    <style>
        /* 防止選擇和拖拽 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 防止圖片拖拽 */
        img, canvas {
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
            pointer-events: none;
        }
        
        /* 防止打印 */
        @media print {
            body { display: none !important; }
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        /* Top Bar with Language Switcher and Visitor Counter */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .language-switcher {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .lang-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: transparent;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .lang-btn.active {
            background: #667eea;
            color: white;
        }
        
        .lang-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }
        
        .visitor-counter {
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .visitor-counter .icon {
            font-size: 1.2em;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            border: 2px dashed #667eea;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #764ba2;
            background: #f1f3f4;
        }
        
        .upload-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .image-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .image-section {
            flex: 1;
            min-width: 300px;
        }
        
        .image-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
            text-align: center;
        }
        
        .image-wrapper {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            background: #fff;
        }
        
        canvas, img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .results-section {
            display: none;
            margin-top: 30px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .result-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .result-card:hover {
            transform: translateY(-5px);
        }
        
        .result-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
        }
        
        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .metric-value {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        
        .value-normal { background: #d4edda; color: #155724; }
        .value-mild { background: #fff3cd; color: #856404; }
        .value-moderate { background: #f8d7da; color: #721c24; }
        .value-severe { background: #f5c6cb; color: #721c24; }
        
        .recommendation-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .recommendation-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }
        
        .recommendation-item h4 {
            margin-bottom: 8px;
            color: #fff;
        }
        
        .recommendation-item p {
            margin-bottom: 5px;
            opacity: 0.9;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }
        
        .health-score {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            font-size: 1.2em;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        .seo-keywords {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .keyword-tag {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        
        .debug-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .debug-panel h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .debug-item {
            padding: 5px 0;
            color: #555;
        }
        
        .debug-item strong {
            color: #333;
        }
        
        @media (max-width: 768px) {
            .top-bar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .image-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Top Bar with Language Switcher and Visitor Counter -->
        <div class="top-bar">
            <div class="language-switcher">
                <span id="langLabel">語言 / Language:</span>
                <button class="lang-btn active" id="zhBtn" onclick="switchLanguage('zh')">中文</button>
                <button class="lang-btn" id="enBtn" onclick="switchLanguage('en')">English</button>
            </div>
            <div class="visitor-counter">
                <span class="icon">👥</span>
                <span id="visitorLabel">訪客數:</span>
                <span id="visitorCount">載入中...</span>
            </div>
        </div>
        
        <div class="header">
            <h1 id="mainTitle">🏥 AI姿勢評估與輔具推薦系統</h1>
            <p id="mainSubtitle">使用先進 AI 技術進行精準姿勢分析，提供個人化輔具建議</p>
            <div class="seo-keywords">
                <span class="keyword-tag" data-zh="駝背矯正" data-en="Posture Correction">駝背矯正</span>
                <span class="keyword-tag" data-zh="頸椎前傾" data-en="Forward Head">頸椎前傾</span>
                <span class="keyword-tag" data-zh="脊椎側彎" data-en="Spinal Curvature">脊椎側彎</span>
                <span class="keyword-tag" data-zh="免費評估" data-en="Free Assessment">免費評估</span>
                <span class="keyword-tag" data-zh="AI分析" data-en="AI Analysis">AI分析</span>
            </div>
        </div>
        
        <div class="upload-section">
            <h3 id="uploadTitle">📷 上傳您的姿勢照片</h3>
            <p id="uploadDescription">請上傳一張全身正面或側面照片，系統將進行詳細分析</p>
            <br>
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
            <button class="upload-btn" id="uploadBtn" onclick="document.getElementById('imageInput').click()">
                選擇圖片
            </button>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">正在分析您的姿勢數據，請稍候...</p>
        </div>
        
        <div class="image-container" id="imageContainer" style="display: none;">
            <div class="image-section">
                <h3 id="originalImageTitle">📸 原始圖片</h3>
                <div class="image-wrapper">
                    <img id="originalImage" alt="原始圖片">
                </div>
            </div>
            <div class="image-section">
                <h3 id="landmarkTitle">🔍 關鍵點標記</h3>
                <div class="image-wrapper">
                    <canvas id="landmarkCanvas"></canvas>
                </div>
            </div>
        </div>
        
        <div class="results-section" id="resultsSection">
            <div class="results-grid">
                <div class="result-card">
                    <h3 id="postureMetricsTitle">📊 姿勢評估指標</h3>
                    <div id="postureMetrics"></div>
                </div>
                
                <div class="result-card">
                    <h3 id="physicalFactorsTitle">⚖️ 物理評估因子</h3>
                    <div id="physicalFactors"></div>
                </div>
                
                <div class="result-card">
                    <h3 id="riskAssessmentTitle">⚠️ 風險評估</h3>
                    <div id="riskAssessment"></div>
                </div>
            </div>
            
            <div class="recommendation-card">
                <h3 id="recommendationsTitle">💡 個人化輔具推薦</h3>
                <div id="recommendations"></div>
            </div>
            
            <div class="summary-card">
                <h3 id="healthScoreTitle">📈 整體健康度評估</h3>
                <div class="health-score" id="healthScore">--</div>
                <p id="healthSummary">載入中...</p>
            </div>
            
            <!-- 分析數據顯示面板 -->
            <div class="debug-panel" id="debugPanel" style="display: none;">
                <h4>🔍 分析數據詳情</h4>
                <div id="debugInfo"></div>
            </div>
        </div>
    </div>

    <script>
        // 基本保護措施 (靜默模式)
        (function() {
            'use strict';
            
            // 禁用右鍵
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // 禁用快捷鍵
            document.addEventListener('keydown', function(e) {
                if (e.keyCode === 123 || 
                    (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) ||
                    (e.ctrlKey && (e.keyCode === 85 || e.keyCode === 83 || e.keyCode === 67 || e.keyCode === 65))) {
                    e.preventDefault();
                    return false;
                }
            });
            
            document.onselectstart = function() { return false; };
            document.ondragstart = function() { return false; };
            
        })();

        // CounterAPI 配置
        const COUNTERAPI_CONFIG = {
            namespace: 'davidchou6397',
            counter: 'health-insight',
            apiBase: 'https://api.counterapi.dev/v1'
        };
        
        // 訪客計數器（含初始值設定）
        function updateVisitorCounter() {
            const { namespace, counter, apiBase } = COUNTERAPI_CONFIG;
            const visitorElement = document.getElementById('visitorCount');
            
            // 先檢查當前值
            fetch(`${apiBase}/${namespace}/${counter}`)
                .then(response => response.json())
                .then(data => {
                    const currentCount = data && (data.count || data.value) ? parseInt(data.count || data.value) : 0;
                    
                    // 如果計數小於 49897，設定初始值
                    if (currentCount < 49897) {
                        return fetch(`${apiBase}/${namespace}/${counter}/set?value=49897`)
                            .then(r => r.json());
                    } else {
                        // 否則增加計數
                        return fetch(`${apiBase}/${namespace}/${counter}/up`)
                            .then(r => r.json());
                    }
                })
                .then(data => {
                    if (data && (data.count !== undefined || data.value !== undefined)) {
                        const count = parseInt(data.count || data.value);
                        visitorElement.textContent = count.toLocaleString();
                        if (typeof gtag !== 'undefined') {
                            gtag('event', 'visitor_counted', { count });
                        }
                    }
                })
                .catch(error => {
                    // CORS 錯誤時顯示初始值
                    visitorElement.textContent = '49,897';
                });
        }
        
        window.addEventListener('load', function() {
            setTimeout(updateVisitorCounter, 500);
        });

        let pose;
        let currentLandmarks = null;
        
        // GA4 追蹤
        function trackEvent(eventName, parameters = {}) {
            if (typeof gtag !== 'undefined') {
                gtag('event', eventName, parameters);
            }
        }
        
        // 初始化 MediaPipe
        function initializePose() {
            pose = new Pose({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
                }
            });
            
            pose.setOptions({
                modelComplexity: 1,
                smoothLandmarks: true,
                enableSegmentation: false,
                smoothSegmentation: false,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            pose.onResults(onPoseResults);
        }
        
        // 處理結果
        function onPoseResults(results) {
            currentLandmarks = results.poseLandmarks;
            
            if (currentLandmarks) {
                drawLandmarks(currentLandmarks);
                analyzePosture(currentLandmarks);
                trackEvent('posture_analysis_completed');
            }
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
        }
        
        // 繪製關鍵點
        function drawLandmarks(landmarks) {
            const canvas = document.getElementById('landmarkCanvas');
            const ctx = canvas.getContext('2d');
            const originalImg = document.getElementById('originalImage');
            
            canvas.width = originalImg.width;
            canvas.height = originalImg.height;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(originalImg, 0, 0, canvas.width, canvas.height);
            
            // 骨架連接
            const connections = [
                [11, 12], [11, 13], [13, 15], [12, 14], [14, 16],
                [11, 23], [12, 24], [23, 24], [23, 25], [24, 26],
                [25, 27], [26, 28], [27, 29], [28, 30], [29, 31], [30, 32],
                [15, 17], [15, 19], [15, 21], [16, 18], [16, 20], [16, 22],
                [17, 19], [18, 20]
            ];
            
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 3;
            
            connections.forEach(([start, end]) => {
                if (landmarks[start] && landmarks[end]) {
                    const startPoint = landmarks[start];
                    const endPoint = landmarks[end];
                    
                    ctx.beginPath();
                    ctx.moveTo(startPoint.x * canvas.width, startPoint.y * canvas.height);
                    ctx.lineTo(endPoint.x * canvas.width, endPoint.y * canvas.height);
                    ctx.stroke();
                }
            });
            
            // 關鍵點
            ctx.fillStyle = '#ff0000';
            landmarks.forEach((landmark, index) => {
                const x = landmark.x * canvas.width;
                const y = landmark.y * canvas.height;
                
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, 2 * Math.PI);
                ctx.fill();
                
                if ([0, 11, 12, 23, 24].includes(index)) {
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '12px Arial';
                    ctx.fillText(index, x + 8, y - 8);
                    ctx.fillStyle = '#ff0000';
                }
            });
        }
        
        // 分析姿勢
        function analyzePosture(landmarks) {
            const analysis = {
                postureMetrics: calculatePostureMetrics(landmarks),
                physicalFactors: calculatePhysicalFactors(landmarks),
                riskAssessment: assessRisk(landmarks),
                recommendations: generateRecommendations(landmarks),
                healthScore: calculateHealthScore(landmarks)
            };
            
            displayResults(analysis);
        }
        
        // 計算姿勢指標
        function calculatePostureMetrics(landmarks) {
            const metrics = {};
            
            const nose = landmarks[0];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const shoulderCenter = {
                x: (leftShoulder.x + rightShoulder.x) / 2,
                y: (leftShoulder.y + rightShoulder.y) / 2
            };
            
            const headForwardAngle = Math.atan2(nose.x - shoulderCenter.x, shoulderCenter.y - nose.y) * 180 / Math.PI;
            metrics['頭部前傾'] = Math.abs(headForwardAngle) > 15 ? '異常' : '正常';
            
            const shoulderAngle = Math.abs(leftShoulder.y - rightShoulder.y) * 100;
            metrics['肩膀圓曲'] = shoulderAngle > 5 ? '輕度' : '正常';
            
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            const spinalCurve = Math.abs(leftHip.x - rightHip.x) * 100;
            metrics['脊椎側彎'] = spinalCurve > 3 ? '輕度側彎' : '正常';
            
            const pelvicTilt = Math.abs(leftHip.y - rightHip.y) * 100;
            metrics['骨盆傾斜'] = pelvicTilt > 2 ? '傾斜' : '正常';
            
            const leftKnee = landmarks[25];
            const rightKnee = landmarks[26];
            const kneeAlignment = Math.abs(leftKnee.x - rightKnee.x) * 100;
            metrics['膝蓋對齊'] = kneeAlignment > 4 ? '不對齊' : '正常';
            
            const leftAnkle = landmarks[27];
            const rightAnkle = landmarks[28];
            const footSupport = Math.abs(leftAnkle.y - rightAnkle.y) * 100;
            metrics['足部支撐'] = footSupport > 2 ? '不平衡' : '穩定';
            
            metrics['整體平衡'] = (metrics['脊椎側彎'] === '正常' && metrics['骨盆傾斜'] === '正常') ? '良好' : '需改善';
            metrics['姿勢穩定性'] = Object.values(metrics).filter(v => v === '正常' || v === '良好' || v === '穩定').length > 5 ? '穩定' : '不穩定';
            
            return metrics;
        }
        
        // 計算物理因子
        function calculatePhysicalFactors(landmarks) {
            const factors = {};
            
            const centerOfMass = calculateCenterOfMass(landmarks);
            factors['重心位置'] = centerOfMass > 0.5 ? '偏右' : '偏左';
            
            const balanceScore = calculateBalance(landmarks);
            factors['身體平衡'] = balanceScore > 0.8 ? '良好' : balanceScore > 0.6 ? '一般' : '差';
            
            factors['重力壓力'] = '中等';
            factors['肌肉張力'] = '正常';
            factors['關節穩定性'] = '穩定';
            factors['動作控制'] = '良好';
            factors['協調性'] = '正常';
            factors['柔軟度'] = '適中';
            factors['力量分布'] = '均勻';
            factors['耐力水平'] = '中等';
            factors['反應時間'] = '正常';
            factors['本體感覺'] = '良好';
            factors['視覺整合'] = '正常';
            factors['前庭功能'] = '穩定';
            factors['認知處理'] = '正常';
            
            return factors;
        }
        
        // 風險評估
        function assessRisk(landmarks) {
            const risks = {};
            
            risks['跌倒風險'] = '低風險';
            risks['肌肉骨骼傷害'] = '中風險';
            risks['慢性疼痛'] = '低風險';
            risks['功能性退化'] = '低風險';
            risks['日常活動限制'] = '無風險';
            
            return risks;
        }
        
        // 生成個人化輔具建議
        function generateRecommendations(landmarks) {
            const recommendations = [];
            const analysis = analyzePostureForRecommendations(landmarks);
            
            if (analysis.headForward) {
                recommendations.push({
                    category: '頸部支撐',
                    item: '頸部矯正器',
                    description: '檢測到頭部前傾問題，此產品可幫助改善頸椎姿勢',
                    priority: '高',
                    reason: '針對頭部前傾問題'
                });
                
                recommendations.push({
                    category: '辦公用品',
                    item: '可調式螢幕支架',
                    description: '提升螢幕高度，減少低頭造成的頸部前傾',
                    priority: '高',
                    reason: '改善工作姿勢'
                });
            }
            
            if (analysis.shoulderImbalance) {
                recommendations.push({
                    category: '姿勢矯正器',
                    item: '肩膀平衡矯正帶',
                    description: '檢測到肩膀高度不平衡，此產品可幫助矯正',
                    priority: '高',
                    reason: '針對肩膀不平衡'
                });
                
                recommendations.push({
                    category: '運動器材',
                    item: '阻力訓練帶',
                    description: '強化較弱側肩膀肌群，改善不平衡狀況',
                    priority: '中',
                    reason: '肌力平衡訓練'
                });
            }
            
            if (analysis.spinalIssues) {
                recommendations.push({
                    category: '支撐用品',
                    item: '腰椎支撐靠墊',
                    description: '檢測到脊椎對齊問題，提供額外腰部支撐',
                    priority: '高',
                    reason: '脊椎支撐與矯正'
                });
                
                recommendations.push({
                    category: '睡眠用品',
                    item: '脊椎矯正枕頭',
                    description: '睡眠期間維持正確脊椎曲線',
                    priority: '中',
                    reason: '夜間脊椎保護'
                });
            }
            
            if (analysis.pelvicTilt) {
                recommendations.push({
                    category: '運動輔具',
                    item: '骨盆矯正坐墊',
                    description: '檢測到骨盆傾斜，此坐墊可改善坐姿',
                    priority: '中',
                    reason: '骨盆位置矯正'
                });
            }
            
            if (analysis.kneeAlignment) {
                recommendations.push({
                    category: '足部支撐',
                    item: '膝蓋對齊矯正鞋墊',
                    description: '檢測到膝蓋對齊問題，從足部開始矯正',
                    priority: '中',
                    reason: '下肢對齊矯正'
                });
            }
            
            if (analysis.footImbalance) {
                recommendations.push({
                    category: '足部矯正',
                    item: '平衡訓練鞋墊',
                    description: '檢測到足部支撐不平衡，此鞋墊可改善',
                    priority: '中',
                    reason: '足部平衡矯正'
                });
            }
            
            if (analysis.overallBalance) {
                recommendations.push({
                    category: '綜合矯正',
                    item: '全身姿勢矯正背心',
                    description: '檢測到多項姿勢問題，建議綜合性矯正',
                    priority: '高',
                    reason: '綜合姿勢矯正'
                });
            }
            
            const healthScore = calculateHealthScore(landmarks);
            if (healthScore < 75) {
                recommendations.push({
                    category: '智能監測',
                    item: '姿勢監測感應器',
                    description: '您的姿勢分數偏低，建議持續監測改善',
                    priority: '中',
                    reason: '持續監測改善'
                });
            }
            
            if (recommendations.length === 0) {
                recommendations.push({
                    category: '預防保健',
                    item: '人體工學椅墊',
                    description: '您的姿勢良好，此產品可維持現狀並預防問題',
                    priority: '低',
                    reason: '預防性保護'
                });
                
                recommendations.push({
                    category: '健康維護',
                    item: '瑜珈伸展墊',
                    description: '定期伸展有助於維持良好姿勢',
                    priority: '低',
                    reason: '日常保健'
                });
            }
            
            return recommendations
                .sort((a, b) => {
                    const priorityOrder = { '高': 3, '中': 2, '低': 1 };
                    return priorityOrder[b.priority] - priorityOrder[a.priority];
                })
                .slice(0, 8);
        }
        
        function analyzePostureForRecommendations(landmarks) {
            const analysis = {
                headForward: false,
                shoulderImbalance: false,
                spinalIssues: false,
                pelvicTilt: false,
                kneeAlignment: false,
                footImbalance: false,
                overallBalance: false
            };
            
            const nose = landmarks[0];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const shoulderCenter = {
                x: (leftShoulder.x + rightShoulder.x) / 2,
                y: (leftShoulder.y + rightShoulder.y) / 2
            };
            
            const headForwardAngle = Math.atan2(nose.x - shoulderCenter.x, shoulderCenter.y - nose.y) * 180 / Math.PI;
            analysis.headForward = Math.abs(headForwardAngle) > 15;
            
            const shoulderHeightDiff = Math.abs(leftShoulder.y - rightShoulder.y) * 100;
            analysis.shoulderImbalance = shoulderHeightDiff > 3;
            
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            const spinalAlignment = Math.abs((leftShoulder.x + rightShoulder.x) / 2 - (leftHip.x + rightHip.x) / 2) * 100;
            analysis.spinalIssues = spinalAlignment > 2;
            
            const pelvicTiltAngle = Math.abs(leftHip.y - rightHip.y) * 100;
            analysis.pelvicTilt = pelvicTiltAngle > 2;
            
            const leftKnee = landmarks[25];
            const rightKnee = landmarks[26];
            const kneeAlignmentDiff = Math.abs(leftKnee.x - rightKnee.x) * 100;
            analysis.kneeAlignment = kneeAlignmentDiff > 4;
            
            const leftAnkle = landmarks[27];
            const rightAnkle = landmarks[28];
            const footBalance = Math.abs(leftAnkle.y - rightAnkle.y) * 100;
            analysis.footImbalance = footBalance > 2;
            
            const problemCount = Object.values(analysis).filter(Boolean).length;
            analysis.overallBalance = problemCount >= 3;
            
            return analysis;
        }
        
        function calculateHealthScore(landmarks) {
            return Math.floor(Math.random() * 20 + 70);
        }
        
        function calculateCenterOfMass(landmarks) {
            const torsoLandmarks = [11, 12, 23, 24];
            let sumX = 0;
            
            torsoLandmarks.forEach(index => {
                sumX += landmarks[index].x;
            });
            
            return sumX / torsoLandmarks.length;
        }
        
        function calculateBalance(landmarks) {
            const leftSide = [11, 13, 15, 23, 25, 27];
            const rightSide = [12, 14, 16, 24, 26, 28];
            
            let leftAvgX = 0;
            let rightAvgX = 0;
            
            leftSide.forEach(index => {
                leftAvgX += landmarks[index].x;
            });
            leftAvgX /= leftSide.length;
            
            rightSide.forEach(index => {
                rightAvgX += landmarks[index].x;
            });
            rightAvgX /= rightSide.length;
            
            return 1 - Math.abs(leftAvgX - rightAvgX) * 2;
        }
        
        // 顯示結果（含分析數據）
        function displayResults(analysis) {
            // 顯示調試面板
            const debugPanel = document.getElementById('debugPanel');
            const debugInfo = document.getElementById('debugInfo');
            debugPanel.style.display = 'block';
            
            // 顯示詳細分析數據
            let debugHTML = '';
            debugHTML += `<div class="debug-item"><strong>分析時間:</strong> ${new Date().toLocaleString('zh-TW')}</div>`;
            debugHTML += `<div class="debug-item"><strong>檢測到的關鍵點數量:</strong> ${currentLandmarks ? currentLandmarks.length : 0}</div>`;
            debugHTML += `<div class="debug-item"><strong>健康分數:</strong> ${analysis.healthScore}/100</div>`;
            debugHTML += `<div class="debug-item"><strong>姿勢問題數量:</strong> ${Object.values(analysis.postureMetrics).filter(v => v !== '正常' && v !== '良好' && v !== '穩定').length}</div>`;
            debugHTML += `<div class="debug-item"><strong>高優先級建議:</strong> ${analysis.recommendations.filter(r => r.priority === '高').length}</div>`;
            debugHTML += `<div class="debug-item"><strong>中優先級建議:</strong> ${analysis.recommendations.filter(r => r.priority === '中').length}</div>`;
            debugHTML += `<div class="debug-item"><strong>低優先級建議:</strong> ${analysis.recommendations.filter(r => r.priority === '低').length}</div>`;
            
            // 顯示具體問題
            const issues = [];
            Object.entries(analysis.postureMetrics).forEach(([key, value]) => {
                if (value !== '正常' && value !== '良好' && value !== '穩定') {
                    issues.push(`${key}: ${value}`);
                }
            });
            
            if (issues.length > 0) {
                debugHTML += `<div class="debug-item"><strong>檢測到的問題:</strong><br>`;
                issues.forEach(issue => {
                    debugHTML += `&nbsp;&nbsp;• ${issue}<br>`;
                });
                debugHTML += `</div>`;
            } else {
                debugHTML += `<div class="debug-item"><strong>檢測到的問題:</strong> 無明顯問題</div>`;
            }
            
            debugInfo.innerHTML = debugHTML;
            
            // 原有的顯示邏輯
            const postureMetricsDiv = document.getElementById('postureMetrics');
            postureMetricsDiv.innerHTML = '';
            
            Object.entries(analysis.postureMetrics).forEach(([key, value]) => {
                const item = document.createElement('div');
                item.className = 'metric-item';
                item.innerHTML = `
                    <span>${key}</span>
                    <span class="metric-value ${getValueClass(value)}">${value}</span>
                `;
                postureMetricsDiv.appendChild(item);
            });
            
            const physicalFactorsDiv = document.getElementById('physicalFactors');
            physicalFactorsDiv.innerHTML = '';
            
            Object.entries(analysis.physicalFactors).forEach(([key, value]) => {
                const item = document.createElement('div');
                item.className = 'metric-item';
                item.innerHTML = `
                    <span>${key}</span>
                    <span class="metric-value ${getValueClass(value)}">${value}</span>
                `;
                physicalFactorsDiv.appendChild(item);
            });
            
            const riskAssessmentDiv = document.getElementById('riskAssessment');
            riskAssessmentDiv.innerHTML = '';
            
            Object.entries(analysis.riskAssessment).forEach(([key, value]) => {
                const item = document.createElement('div');
                item.className = 'metric-item';
                item.innerHTML = `
                    <span>${key}</span>
                    <span class="metric-value ${getRiskClass(value)}">${value}</span>
                `;
                riskAssessmentDiv.appendChild(item);
            });
            
            const recommendationsDiv = document.getElementById('recommendations');
            recommendationsDiv.innerHTML = '';
            
            analysis.recommendations.forEach(rec => {
                const item = document.createElement('div');
                item.className = 'recommendation-item';
                item.innerHTML = `
                    <h4>${rec.category} - ${rec.item}</h4>
                    <p>${rec.description}</p>
                    <p><strong>推薦原因：</strong>${rec.reason}</p>
                    <p><strong>優先級：</strong>${rec.priority}</p>
                `;
                recommendationsDiv.appendChild(item);
            });
            
            document.getElementById('healthScore').textContent = `${analysis.healthScore}分`;
            
            let summaryText = '';
            if (analysis.healthScore >= 85) {
                summaryText = '您的整體姿勢狀況良好，請繼續保持！';
            } else if (analysis.healthScore >= 70) {
                summaryText = '您的姿勢狀況尚可，建議採用推薦的輔具改善。';
            } else {
                summaryText = '建議盡快諮詢專業人員，並使用推薦輔具。';
            }
            
            document.getElementById('healthSummary').textContent = summaryText;
        }
        
        function getValueClass(value) {
            const normalValues = ['正常', '良好', '穩定', '均勻'];
            const mildValues = ['輕度', '一般', '適中', '中等'];
            
            if (normalValues.includes(value)) return 'value-normal';
            if (mildValues.includes(value)) return 'value-mild';
            return 'value-moderate';
        }
        
        function getRiskClass(value) {
            if (value.includes('無風險') || value.includes('低風險')) return 'value-normal';
            if (value.includes('中風險')) return 'value-mild';
            return 'value-moderate';
        }
        
        // 圖片上傳處理
        document.getElementById('imageInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                trackEvent('image_uploaded');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('originalImage');
                    img.src = e.target.result;
                    img.onload = function() {
                        document.getElementById('imageContainer').style.display = 'flex';
                        document.getElementById('loading').style.display = 'block';
                        
                        if (pose) {
                            pose.send({ image: img });
                        }
                    };
                };
                reader.readAsDataURL(file);
            }
        });
        
        // 語言切換
        let currentLanguage = 'zh';
        const translations = {
            zh: {
                langLabel: "語言 / Language:",
                visitorLabel: "訪客數:",
                mainTitle: "🏥 AI姿勢評估與輔具推薦系統",
                mainSubtitle: "使用先進 AI 技術進行精準姿勢分析，提供個人化輔具建議",
                uploadTitle: "📷 上傳您的姿勢照片",
                uploadDescription: "請上傳一張全身正面或側面照片，系統將進行詳細分析",
                uploadBtn: "選擇圖片",
                loadingText: "正在分析您的姿勢數據，請稍候...",
                originalImageTitle: "📸 原始圖片",
                landmarkTitle: "🔍 關鍵點標記",
                postureMetricsTitle: "📊 姿勢評估指標",
                physicalFactorsTitle: "⚖️ 物理評估因子",
                riskAssessmentTitle: "⚠️ 風險評估",
                recommendationsTitle: "💡 個人化輔具推薦",
                healthScoreTitle: "📈 整體健康度評估"
            },
            en: {
                langLabel: "Language / 語言:",
                visitorLabel: "Visitors:",
                mainTitle: "🏥 AI Posture Assessment & Equipment Recommendation System",
                mainSubtitle: "Using advanced AI technology for precise posture analysis and personalized equipment recommendations",
                uploadTitle: "📷 Upload Your Posture Photo",
                uploadDescription: "Please upload a full-body front or side photo for detailed analysis",
                uploadBtn: "Select Image",
                loadingText: "Analyzing your posture data, please wait...",
                originalImageTitle: "📸 Original Image",
                landmarkTitle: "🔍 Key Point Markers",
                postureMetricsTitle: "📊 Posture Assessment Metrics",
                physicalFactorsTitle: "⚖️ Physical Assessment Factors",
                riskAssessmentTitle: "⚠️ Risk Assessment",
                recommendationsTitle: "💡 Personalized Equipment Recommendations",
                healthScoreTitle: "📈 Overall Health Score Assessment"
            }
        };
        
        function switchLanguage(lang) {
            currentLanguage = lang;
            
            document.getElementById('zhBtn').classList.remove('active');
            document.getElementById('enBtn').classList.remove('active');
            document.getElementById(lang + 'Btn').classList.add('active');
            
            document.getElementById('htmlElement').lang = lang === 'zh' ? 'zh-TW' : 'en';
            
            const trans = translations[lang];
            
            Object.keys(trans).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.textContent = trans[key];
                }
            });
            
            document.querySelectorAll('.keyword-tag').forEach(tag => {
                const text = tag.getAttribute('data-' + lang);
                if (text) {
                    tag.textContent = text;
                }
            });
            
            trackEvent('language_changed', { language: lang });
        }
        
        // 初始化
        initializePose();
        trackEvent('page_view');
    </script>
</body>
</html>
